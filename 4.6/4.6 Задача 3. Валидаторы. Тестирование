# Задача 3. Валидаторы. Тестирование


import unittest
import sys
import os

# Adjusting the path to ensure the app.py can be imported if it's in the same directory.
# تنظیم مسیر برای اطمینان از اینکه app.py می‌تواند وارد شود، اگر در همان دایرکتوری است.
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__))))

# Import the Flask app and RegistrationForm from the 'app' module.
# اطمینان حاصل کنید که app.py در همان دایرکتوری test_app.py قرار دارد.
# Flask app و RegistrationForm را از ماژول 'app' وارد کنید.
try:
    from app import app, RegistrationForm, number_length, NumberLength
except ImportError:
    print("Error: Could not import 'app', 'RegistrationForm', 'number_length', or 'NumberLength' from app.py.")
    print("Please ensure app.py exists in the same directory and contains the Flask app, form, and custom validators.")
    sys.exit(1) # Exit if the necessary components cannot be imported.


class TestRegistrationFormValidation(unittest.TestCase):
    """
    Unit tests for the RegistrationForm validators.
    Covers validation success and failure for each field using the Flask test client.
    تست‌های واحد برای ولیدیتورهای RegistrationForm.
    موفقیت و شکست ولیداسیون را برای هر فیلد با استفاده از کلاینت تست Flask پوشش می‌دهد.
    """

    @classmethod
    def setUpClass(cls) -> None:
        """
        Set up the Flask test client once for all tests in this class.
        یک بار کلاینت تست Flask را برای همه تست‌ها در این کلاس تنظیم کنید.
        """
        cls.app = app.test_client()
        cls.app.testing = True

    def test_email_valid(self) -> None:
        """
        Tests successful validation of a valid email address.
        تست موفقیت آمیز اعتبارسنجی یک آدرس ایمیل معتبر.
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Registration successful!", response.data) # Check for success message
        self.assertNotIn(b"Email is required.", response.data)
        self.assertNotIn(b"Invalid email format.", response.data)

    def test_email_invalid_format(self) -> None:
        """
        Tests failed validation for an invalid email format.
        تست اعتبارسنجی ناموفق برای یک فرمت ایمیل نامعتبر.
        """
        data = {
            'email': 'invalid-email', # Invalid format
            'phone': 1234567890,
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Invalid email format.", response.data)
        self.assertNotIn(b"Registration successful!", response.data)

    def test_email_missing(self) -> None:
        """
        Tests failed validation when email is missing (InputRequired).
        تست اعتبارسنجی ناموفق زمانی که ایمیل حذف شده است (InputRequired).
        """
        data = {
            'phone': 1234567890,
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Email is required.", response.data)
        self.assertNotIn(b"Registration successful!", response.data)
        
    def test_phone_valid(self) -> None:
        """
        Tests successful validation of a valid 10-digit phone number.
        تست موفقیت آمیز اعتبارسنجی یک شماره تلفن معتبر 10 رقمی.
        """
        data = {
            'email': 'test@example.com',
            'phone': 9876543210, # 10 digits
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Registration successful!", response.data)
        self.assertNotIn(b"Phone number must be exactly 10 digits.", response.data)
    
    def test_phone_too_short(self) -> None:
        """
        Tests failed validation for a phone number with less than 10 digits.
        تست اعتبارسنجی ناموفق برای شماره تلفنی با کمتر از 10 رقم.
        """
        data = {
            'email': 'test@example.com',
            'phone': 12345, # Too short
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Phone number must be exactly 10 digits.", response.data)
        self.assertNotIn(b"Registration successful!", response.data)

    def test_phone_too_long(self) -> None:
        """
        Tests failed validation for a phone number with more than 10 digits.
        تست اعتبارسنجی ناموفق برای شماره تلفنی با بیش از 10 رقم.
        """
        data = {
            'email': 'test@example.com',
            'phone': 12345678901, # Too long
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Phone number must be exactly 10 digits.", response.data)
        self.assertNotIn(b"Registration successful!", response.data)

    def test_phone_negative(self) -> None:
        """
        Tests failed validation for a negative phone number.
        تست اعتبارسنجی ناموفق برای شماره تلفن منفی.
        """
        data = {
            'email': 'test@example.com',
            'phone': -1234567890, # Negative
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        # Note: IntegerField would handle the negative value as a valid int.
        # The custom number_length validator primarily checks string length,
        # so for explicit positivity, NumberRange(min=0) should be added.
        # For a 10-digit number, the custom validator's min=1000000000 implicitly handles positivity.
        self.assertIn(b"Phone number must be exactly 10 digits.", response.data) # Still fails on length for -ve numbers
        self.assertNotIn(b"Registration successful!", response.data)

    def test_phone_missing(self) -> None:
        """
        Tests failed validation when phone number is missing.
        تست اعتبارسنجی ناموفق زمانی که شماره تلفن حذف شده است.
        """
        data = {
            'email': 'test@example.com',
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Phone number is required.", response.data)
        self.assertNotIn(b"Registration successful!", response.data)

    def test_name_valid(self) -> None:
        """
        Tests successful validation of a valid name.
        تست موفقیت آمیز اعتبارسنجی یک نام معتبر.
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'name': 'Valid Name',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Registration successful!", response.data)
        self.assertNotIn(b"Name is required.", response.data)

    def test_name_missing(self) -> None:
        """
        Tests failed validation when name is missing.
        تست اعتبارسنجی ناموفق زمانی که نام حذف شده است.
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'address': '123 Test St',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Name is required.", response.data)
        self.assertNotIn(b"Registration successful!", response.data)

    def test_address_valid(self) -> None:
        """
        Tests successful validation of a valid address.
        تست موفقیت آمیز اعتبارسنجی یک آدرس معتبر.
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'name': 'Test User',
            'address': 'Valid Address, Apt 101',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Registration successful!", response.data)
        self.assertNotIn(b"Address is required.", response.data)

    def test_address_missing(self) -> None:
        """
        Tests failed validation when address is missing.
        تست اعتبارسنجی ناموفق زمانی که آدرس حذف شده است.
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'name': 'Test User',
            'index': 12345,
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Address is required.", response.data)
        self.assertNotIn(b"Registration successful!", response.data)

    def test_index_valid(self) -> None:
        """
        Tests successful validation of a valid index (integer).
        تست موفقیت آمیز اعتبارسنجی یک کد پستی معتبر (عدد صحیح).
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'name': 'Test User',
            'address': '123 Test St',
            'index': 67890, # Valid integer
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Registration successful!", response.data)
        self.assertNotIn(b"Index is required.", response.data)
        self.assertNotIn(b"Not a valid integer.", response.data)

    def test_index_missing(self) -> None:
        """
        Tests failed validation when index is missing.
        تست اعتبارسنجی ناموفق زمانی که کد پستی حذف شده است.
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'name': 'Test User',
            'address': '123 Test St',
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Index is required.", response.data)
        self.assertNotIn(b"Registration successful!", response.data)

    def test_index_non_integer(self) -> None:
        """
        Tests failed validation when index is not an integer.
        تست اعتبارسنجی ناموفق زمانی که کد پستی عدد صحیح نیست.
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'name': 'Test User',
            'address': '123 Test St',
            'index': 'abc', # Non-integer
            'comment': 'Valid comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Not a valid integer.", response.data) # Default WTForms error for non-integer
        self.assertNotIn(b"Registration successful!", response.data)

    def test_comment_valid_present(self) -> None:
        """
        Tests successful validation when comment is present (optional field).
        تست موفقیت آمیز اعتبارسنجی زمانی که کامنت وجود دارد (فیلد اختیاری).
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            'comment': 'This is an optional comment.'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Registration successful!", response.data)

    def test_comment_valid_missing(self) -> None:
        """
        Tests successful validation when comment is missing (optional field).
        تست موفقیت آمیز اعتبارسنجی زمانی که کامنت حذف شده است (فیلد اختیاری).
        """
        data = {
            'email': 'test@example.com',
            'phone': 1234567890,
            'name': 'Test User',
            'address': '123 Test St',
            'index': 12345,
            # 'comment' is intentionally omitted
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Registration successful!", response.data)
        # Ensure no "comment is required" error appears
        self.assertNotIn(b"comment is required", response.data.decode('utf-8').lower())

    def test_all_fields_invalid(self) -> None:
        """
        Tests scenario where multiple fields fail validation simultaneously.
        تست سناریویی که چندین فیلد به طور همزمان در اعتبارسنجی شکست می‌خورند.
        """
        data = {
            'email': 'bad_email',
            'phone': 123, # Too short
            'name': '',   # Missing
            'address': '',# Missing
            'index': 'xyz',# Non-integer
            'comment': 'This is a comment'
        }
        response = self.app.post('/registration', data=data)
        self.assertEqual(response.status_code, 200)
        self.assertIn(b"Invalid email format.", response.data)
        self.assertIn(b"Phone number must be exactly 10 digits.", response.data)
        self.assertIn(b"Name is required.", response.data)
        self.assertIn(b"Address is required.", response.data)
        self.assertIn(b"Not a valid integer.", response.data)
        self.assertNotIn(b"Registration successful!", response.data)

if __name__ == '__main__':
    # Run the tests.
    # تست‌ها را اجرا کنید.
    unittest.main(argv=['first-arg-is-ignored'], exit=False)
