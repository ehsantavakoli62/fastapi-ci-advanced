# Задача 6. /get_random_word

from flask import Flask
import random
import re       # Module for regular expressions / ماژول برای عبارات با قاعده
import os       # Module for operating system interactions / ماژول برای تعاملات سیستم عامل

# --- Configuration and Initialization ---
# Create an instance of the Flask application
# یک نمونه از برنامه Flask ایجاد کنید
app = Flask(__name__)

# Determine the base directory for file safety
# تعیین دایرکتوری پایه برای امنیت فایل
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
BOOK_FILE = os.path.join(BASE_DIR, 'war_and_peace.txt')

# --- Helper function to generate a dummy book file for testing ---
# --- تابع کمکی برای تولید یک فایل کتاب ساختگی برای تست ---
def create_dummy_book_file(filename):
    """Generates a small dummy text file for testing."""
    # یک فایل متنی ساختگی کوچک برای تست تولید می‌کند.
    if not os.path.exists(filename):
        print(f"Creating dummy file: {filename}")
        # در حال ایجاد فایل ساختگی:
        with open(filename, 'w', encoding='utf-8') as f:
            f.write("Когда я говорю о Толстом, я имею в виду прежде всего «Войну и мир».")
            f.write("Андрей Болконский. Пьер Безухов. Наташа Ростова. Война, Мир, Счастье. 123-456")
            # When I talk about Tolstoy, I primarily mean "War and Peace".
            # Andrey Bolkonsky. Pierre Bezukhov. Natasha Rostova. War, Peace, Happiness. 123-456


def get_words_from_file(filepath: str) -> list[str]:
    """
    Reads the content of the file and extracts a list of words.
    Punctuation is removed, and words are returned in lowercase.
    
    محتوای فایل را می‌خواند و لیستی از کلمات را استخراج می‌کند.
    علائم نگارشی حذف می‌شوند و کلمات به حروف کوچک برگردانده می‌شوند.
    
    Args:
        filepath (str): The absolute path to the book file.
        مسیر مطلق فایل کتاب.
        
    Returns:
        list[str]: A list of clean, non-empty words.
        لیستی از کلمات تمیز و غیر خالی.
        
    Raises:
        FileNotFoundError: If the book file does not exist.
        FileNotFoundError: اگر فایل کتاب وجود نداشته باشد.
    """
    try:
        with open(filepath, 'r', encoding='utf-8') as book:
            text = book.read()
            
            # Use regex to find all sequences of letters (Russian or English)
            # از regex برای یافتن تمام دنباله‌های حروف (روسی یا انگلیسی) استفاده کنید
            # \b matches word boundaries, [a-zA-Zа-яА-Я]+ matches one or more letters
            # \b مرزهای کلمه را مطابقت می‌دهد، [a-zA-Zа-яА-Я]+ با یک یا چند حرف مطابقت دارد
            words = re.findall(r'[a-zA-Zа-яА-Я]+', text.lower())
            
            return words
    except FileNotFoundError:
        # Re-raise the error so Flask can handle it (or use try-except in main)
        # خطا را دوباره پرتاب کنید تا Flask بتواند آن را مدیریت کند (یا از try-except در main استفاده کنید)
        raise FileNotFoundError(f"Book file not found at: {filepath}")
        # فایل کتاب در مسیر: {filepath} یافت نشد.


# --- Global Data Initialization ---
# The list of words is loaded only once when the script starts,
# meeting the requirement not to open the file on every request.
# لیست کلمات فقط یک بار هنگام شروع اسکریپت بارگذاری می‌شود،
# که نیاز به عدم باز کردن فایل در هر درخواست را برآورده می‌کند.
try:
    create_dummy_book_file(BOOK_FILE) # Ensure the file exists for demonstration / اطمینان از وجود فایل برای نمایش
    WORDS = get_words_from_file(BOOK_FILE)
    if not WORDS:
        print("Warning: The word list is empty! / هشدار: لیست کلمات خالی است!")
except FileNotFoundError as e:
    print(f"FATAL ERROR: {e}")
    # خطای مهلک:
    WORDS = [] # Empty list to prevent crashes / لیست خالی برای جلوگیری از کرش
except Exception as e:
    print(f"An unexpected error occurred during file processing: {e}")
    # یک خطای غیرمنتظره هنگام پردازش فایل رخ داد:
    WORDS = []


# --- Flask Route ---
@app.route('/get_random_word')
def get_random_word():
    """
    Returns a random word from the globally loaded list of words.
    
    یک کلمه تصادفی از لیست کلمات بارگذاری شده سراسری را برمی‌گرداند.
    """
    if not WORDS:
        return "Error: Word list is empty or file was not loaded."
        # خطا: لیست کلمات خالی است یا فایل بارگذاری نشده است.
        
    # Select a random word from the list
    # یک کلمه تصادفی از لیست انتخاب کنید
    random_word = random.choice(WORDS)
    
    # Return the word (it is already clean due to regex extraction)
    # کلمه را برمی‌گرداند (به دلیل استخراج regex از قبل تمیز است)
    return random_word


if __name__ == '__main__':
    # Run the Flask application in debug mode
    # برنامه Flask را در حالت اشکال‌زدایی اجرا کنید
    print(f"Base Directory: {BASE_DIR}")
    print(f"Book File Path: {BOOK_FILE}")
    print(f"Total words loaded: {len(WORDS)}")
    app.run(debug=True)
