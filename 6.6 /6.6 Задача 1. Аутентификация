# Задача 1. Аутентификация

from flask import Flask, request, jsonify, render_template_string
from flask_wtf import FlaskForm
from wtforms import StringField, IntegerField, TextAreaField
from wtforms.validators import InputRequired, NumberRange, ValidationError, Length
from typing import Dict, Any, List, Optional
import subprocess
import shlex
import sys
import os
import logging # Import the logging module / ماژول logging را وارد کنید

# --- Logging Configuration ---
# --- پیکربندی لاگینگ ---

# 1. Create a logger instance / یک نمونه لاگر ایجاد کنید
logger = logging.getLogger(__name__) # Get a logger for this module / یک لاگر برای این ماژول بگیرید
logger.setLevel(logging.INFO) # Set the minimum level to INFO / حداقل سطح را روی INFO تنظیم کنید

# 2. Create a file handler / یک فایل هندلر ایجاد کنید
log_file_name = 'stderr.txt'
# Create/clear the file on start / فایل را در شروع ایجاد/پاک کنید
if os.path.exists(log_file_name):
    with open(log_file_name, 'w'):
        pass # Clears the file content / محتوای فایل را پاک می‌کند

file_handler = logging.FileHandler(log_file_name, encoding='utf-8')

# 3. Create a formatter without date, with time in HH:MM:SS format / یک فرمتر بدون تاریخ، با زمان در فرمت HH:MM:SS ایجاد کنید
formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s', datefmt='%H:%M:%S')

# 4. Add the formatter to the file handler / فرمتر را به فایل هندلر اضافه کنید
file_handler.setFormatter(formatter)

# 5. Add the file handler to the logger / فایل هندلر را به لاگر اضافه کنید
logger.addHandler(file_handler)

# --- End Logging Configuration ---
# --- پایان پیکربندی لاگینگ ---


# Create an instance of the Flask application
# یک نمونه از برنامه Flask ایجاد کنید
app = Flask(__name__)

# Set a secret key for Flask-WTF forms. Required for CSRF protection.
# یک کلید مخفی برای فرم‌های Flask-WTF تنظیم کنید. برای حفاظت CSRF الزامی است.
app.config['SECRET_KEY'] = 'a_very_secret_key_for_code_execution_app' 

# --- Helper function to check for prlimit availability ---
# --- تابع کمکی برای بررسی در دسترس بودن prlimit ---
def is_prlimit_available() -> bool:
    """Checks if the 'prlimit' command is available on the system."""
    """بررسی می‌کند که آیا دستور 'prlimit' در سیستم موجود است یا خیر."""
    return sys.platform.startswith('linux') and os.path.exists('/usr/bin/prlimit')


# --- Form Definition ---
# --- تعریف فرم ---
class CodeExecutionForm(FlaskForm):
    """
    Form for submitting Python code and a timeout for execution.
    فرم برای ارسال کد پایتون و یک تایم‌اوت برای اجرا.
    """
    code = TextAreaField(
        'Python Code', 
        validators=[
            InputRequired(message="Code field cannot be empty. / فیلد کد نمی‌تواند خالی باشد."),
            Length(min=1, message="Code cannot be empty. / کد نمی‌تواند خالی باشد.")
        ]
    )
    timeout = IntegerField(
        'Timeout (seconds)', 
        validators=[
            InputRequired(message="Timeout is required. / تایم‌اوت الزامی است."),
            NumberRange(min=1, max=30, message="Timeout must be between 1 and 30 seconds. / تایم‌اوت باید بین 1 تا 30 ثانیه باشد.")
        ]
    )


@app.route('/execute_code', methods=['GET', 'POST'])
def execute_code_endpoint():
    """
    Endpoint to receive Python code and execute it with a specified timeout.
    
    نقطه پایانی برای دریافت کد پایتون و اجرای آن با یک تایم‌اوت مشخص.
    """
    form = CodeExecutionForm()

    if form.validate_on_submit():
        user_code = form.code.data
        timeout = form.timeout.data
        
        logger.info(f"Received code execution request. Timeout: {timeout}s") # Log INFO message / پیام INFO را لاگ کنید

        # Prepare the command to run Python code.
        cmd: List[str] = [sys.executable, "-c", user_code]

        if is_prlimit_available():
            cmd = ["prlimit", "--nproc=1:1"] + cmd
            logger.debug(f"Using prlimit: {' '.join(cmd)}") # Log DEBUG message (will not be shown due to INFO level) / پیام DEBUG را لاگ کنید (به دلیل سطح INFO نمایش داده نخواهد شد)
        else:
            logger.warning("prlimit not available or not Linux. Proceeding without resource limits. This may be a security risk.") # Log WARNING message / پیام WARNING را لاگ کنید

        try:
            process = subprocess.Popen(
                cmd, 
                stdout=subprocess.PIPE, 
                stderr=subprocess.PIPE, 
                text=True, 
                shell=False 
            )
            
            stdout_output, stderr_output = process.communicate(timeout=timeout)

            if process.returncode == 0:
                logger.info("Code executed successfully.") # Log success / موفقیت را لاگ کنید
                logger.debug(f"Stdout: {stdout_output.strip()}") # Log details / جزئیات را لاگ کنید
                return jsonify({
                    "status": "success",
                    "output": stdout_output.strip()
                })
            else:
                logger.error(f"Code execution failed with return code {process.returncode}. Stderr: {stderr_output.strip()}") # Log error / خطا را لاگ کنید
                return jsonify({
                    "status": "error",
                    "output": stderr_output.strip(),
                    "return_code": process.returncode
                }), 400

        except subprocess.TimeoutExpired:
            process.kill()
            stdout_output, stderr_output = process.communicate()
            logger.warning(f"Code execution timed out after {timeout} seconds. Output: {stdout_output.strip()}, Error: {stderr_output.strip()}") # Log timeout / تایم‌اوت را لاگ کنید
            return jsonify({
                "status": "timeout",
                "message": f"Code execution timed out after {timeout} seconds.",
                "output_before_timeout": stdout_output.strip(),
                "error_before_timeout": stderr_output.strip()
            }), 408
        except FileNotFoundError:
            logger.critical("Python interpreter or prlimit command not found. Check system PATH.") # Log critical error / خطای حیاتی را لاگ کنید
            return jsonify({
                "status": "error",
                "message": "Python interpreter or prlimit command not found. / مفسر پایتون یا دستور prlimit یافت نشد."
            }), 500
        except Exception as e:
            logger.exception("An unexpected server error occurred during code execution.") # Log exception with traceback / استثنا را با Traceback لاگ کنید
            return jsonify({
                "status": "error",
                "message": f"An unexpected server error occurred: {str(e)} / یک خطای سرور غیرمنتظره رخ داد: {str(e)}"
            }), 500
    
    # If it's a GET request or form validation failed, render the form.
    if request.method == 'GET':
        logger.info("Serving code execution form page.") # Log serving form / ارائه فرم را لاگ کنید
    else: # POST request with validation errors
        logger.warning(f"Form validation failed. Errors: {form.errors}") # Log validation errors / خطاهای اعتبارسنجی را لاگ کنید

    return render_template_string("""
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <title>Python Code Executor</title>
            <style>
                body { font-family: sans-serif; margin: 2em; }
                form { background: #f9f9f9; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
                textarea, input[type="number"] { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
                input[type="submit"] { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
                input[type="submit"]:hover { background-color: #45a049; }
                .error { color: red; font-size: 0.9em; }
                pre { background-color: #eee; padding: 10px; border-radius: 4px; overflow-x: auto; }
            </style>
        </head>
        <body>
            <h1>Execute Python Code</h1>
            <form method="POST">
                {{ form.csrf_token }}
                <p>
                    {{ form.code.label }}<br>
                    {{ form.code(rows=10, cols=80) }}
                    {% if form.code.errors %}<span class="error">{% for error in form.code.errors %}{{ error }}{% endfor %}</span>{% endif %}
                </p>
                <p>
                    {{ form.timeout.label }}<br>
                    {{ form.timeout() }}
                    {% if form.timeout.errors %}<span class="error">{% for error in form.timeout.errors %}{{ error }}{% endfor %}</span>{% endif %}
                </p>
                <p><input type="submit" value="Execute Code"></p>
            </form>
            {% if request.method == 'POST' and not form.errors %}
                <h2>Result:</h2>
                <pre>{{ response_json }}</pre>
            {% endif %}
        </body>
        </html>
    """, form=form, response_json=json.dumps(request.json if request.json else request.args.to_dict(flat=False), indent=2) if request.method == 'POST' and not form.errors else "Submit code to see result.")


if __name__ == '__main__':
    app.run(debug=True)
