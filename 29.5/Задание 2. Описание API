from flask import Flask, request, jsonify
from models import db, Client, Parking, ClientParking, create_app
from datetime import datetime

app = create_app()

with app.app_context():
    db.create_all()

# --- Роуты для клиентов ---

@app.route("/clients", methods=["GET"])
def get_clients():
    clients = Client.query.all()
    return jsonify([{
        "id": c.id,
        "name": c.name,
        "surname": c.surname,
        "credit_card": c.credit_card,
        "car_number": c.car_number
    } for c in clients])

@app.route("/clients/<int:client_id>", methods=["GET"])
def get_client(client_id):
    client = Client.query.get_or_404(client_id)
    return jsonify({
        "id": client.id,
        "name": client.name,
        "surname": client.surname,
        "credit_card": client.credit_card,
        "car_number": client.car_number
    })

@app.route("/clients", methods=["POST"])
def create_client():
    data = request.json
    client = Client(
        name=data["name"],
        surname=data["surname"],
        credit_card=data.get("credit_card"),
        car_number=data.get("car_number")
    )
    db.session.add(client)
    db.session.commit()
    return jsonify({"id": client.id, "name": client.name, "surname": client.surname}), 201

# --- Роуты для парковок ---

@app.route("/parkings", methods=["POST"])
def create_parking():
    data = request.json
    parking = Parking(
        address=data["address"],
        opened=data.get("opened", True),
        count_places=data["count_places"],
        count_available_places=data["count_places"]
    )
    db.session.add(parking)
    db.session.commit()
    return jsonify({"id": parking.id, "address": parking.address}), 201

# --- Заезд на парковку ---
@app.route("/client_parkings", methods=["POST"])
def enter_parking():
    data = request.json
    client = Client.query.get_or_404(data["client_id"])
    parking = Parking.query.get_or_404(data["parking_id"])

    if not parking.opened:
        return jsonify({"error": "Parking is closed"}), 400
    if parking.count_available_places <= 0:
        return jsonify({"error": "No available places"}), 400

    # Создаем запись о заезде
    cp = ClientParking(
        client_id=client.id,
        parking_id=parking.id,
        time_in=datetime.utcnow()
    )
    parking.count_available_places -= 1
    db.session.add(cp)
    db.session.commit()
    return jsonify({"message": f"Client {client.id} entered parking {parking.id}"}), 201

# --- Выезд с парковки ---
@app.route("/client_parkings", methods=["DELETE"])
def exit_parking():
    data = request.json
    client = Client.query.get_or_404(data["client_id"])
    parking = Parking.query.get_or_404(data["parking_id"])

    cp = ClientParking.query.filter_by(client_id=client.id, parking_id=parking.id, time_out=None).first()
    if not cp:
        return jsonify({"error": "Client not found in parking"}), 404
    if not client.credit_card:
        return jsonify({"error": "Client has no credit card attached"}), 400

    cp.time_out = datetime.utcnow()
    parking.count_available_places += 1
    db.session.commit()
    return jsonify({"message": f"Client {client.id} exited parking {parking.id}"}), 200

if __name__ == "__main__":
    app.run(debug=True)
